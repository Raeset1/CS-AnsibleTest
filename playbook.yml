---
- name: Webserver mit Live Systeminfo (Apache + CGI)
  hosts: web
  become: true

  tasks:
    - name: Apache installieren
      ansible.builtin.apt:
        name: apache2
        state: present
        update_cache: true

    - name: CGI Modul aktivieren
      ansible.builtin.command: a2enmod cgi
      args:
        creates: /etc/apache2/mods-enabled/cgi.load
      notify: Restart apache

    - name: Apache starten und aktivieren
      ansible.builtin.service:
        name: apache2
        state: started
        enabled: true

    # (Optional, aber sinnvoll) cgi-bin Verzeichnis sicherstellen
    - name: cgi-bin Verzeichnis sicherstellen
      ansible.builtin.file:
        path: /usr/lib/cgi-bin
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Live Systeminfo CGI Script deployen
      ansible.builtin.copy:
        dest: /usr/lib/cgi-bin/sysinfo.sh
        owner: root
        group: root
        mode: "0755"
        content: |
          #!/bin/bash
          echo "Content-Type: text/html"
          echo ""
          cat <<'HTML'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Live Systeminfo</title>
            <meta http-equiv="refresh" content="5">
            <style>
              body { font-family: Arial; padding: 20px; }
              table { border-collapse: collapse; background: #fff; }
              td { border: 1px solid #ccc; padding: 8px 12px; }
            </style>
          </head>
          <body>
            <h1>ðŸŸ¢ Live Systeminfo</h1>
          HTML

          HOSTNAME="$(hostname)"
          UPTIME="$(uptime -p 2>/dev/null || uptime)"
          KERNEL="$(uname -r)"
          CPU="$(nproc 2>/dev/null || grep -c ^processor /proc/cpuinfo)"
          RAM="$(free -m | awk '/Mem:/ {print $2 " MB"}')"
          IP="$(hostname -I 2>/dev/null | awk '{print $1}')"
          TIME="$(date -Is)"

          echo "<table>"
          echo "<tr><td><b>Hostname</b></td><td>${HOSTNAME}</td></tr>"
          echo "<tr><td><b>Uptime</b></td><td>${UPTIME}</td></tr>"
          echo "<tr><td><b>Kernel</b></td><td>${KERNEL}</td></tr>"
          echo "<tr><td><b>CPU (vCPUs)</b></td><td>${CPU}</td></tr>"
          echo "<tr><td><b>RAM (gesamt)</b></td><td>${RAM}</td></tr>"
          echo "<tr><td><b>IP</b></td><td>${IP}</td></tr>"
          echo "<tr><td><b>Zeit</b></td><td>${TIME}</td></tr>"
          echo "</table>"

          echo "</body></html>"

  handlers:
    - name: Restart apache
      ansible.builtin.service:
        name: apache2
        state: restarted
